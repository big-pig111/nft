<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Solana NFT é“¸é€ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
  
  <!-- SPL Token -->
  <script src="https://unpkg.com/@solana/spl-token@0.3.9/lib/index.iife.min.js"></script>
  <script>
    // è°ƒè¯•ï¼šæŸ¥çœ‹å…¨å±€å¯¹è±¡
    console.log("å…¨å±€å¯¹è±¡:", Object.keys(window).filter(key => key.includes('solana') || key.includes('token') || key.includes('spl')));
    
    // ç®€å•çš„åˆå§‹åŒ–æ–¹æ³•
    window.splToken = window["@solana/spl-token"];
    
    // æ£€æŸ¥æ˜¯å¦åŠ è½½æˆåŠŸ
    if (window.splToken) {
      console.log("SPL Token åº“åŠ è½½æˆåŠŸ");
      console.log("å¯ç”¨æ–¹æ³•:", Object.keys(window.splToken));
    } else {
      console.error("SPL Token åº“åŠ è½½å¤±è´¥");
      // å°è¯•å…¶ä»–å¯èƒ½çš„åç§°
      const possibleNames = ['splToken', 'SplToken', 'SPL_TOKEN', '@solana/spl-token'];
      for (const name of possibleNames) {
        if (window[name]) {
          window.splToken = window[name];
          console.log(`æ‰¾åˆ° SPL Token åº“: ${name}`);
          break;
        }
      }
      
      if (!window.splToken) {
        console.error("æ‰€æœ‰å°è¯•éƒ½å¤±è´¥");
      }
    }
  </script>
</head>
<body class="bg-gray-100">
  <div class="max-w-xl mx-auto mt-10 p-6 bg-white shadow-lg rounded-xl">
    <h1 class="text-2xl font-bold mb-4">Solana ä¸»ç½‘ NFT é“¸é€ </h1>
    <button id="connectWallet" class="bg-blue-600 text-white px-4 py-2 rounded mb-4">è¿æ¥é’±åŒ…</button>
    <input id="nftName" type="text" placeholder="è¾“å…¥ NFT åç§°" class="border p-2 w-full mb-2" />
    <textarea id="nftDesc" placeholder="è¾“å…¥æè¿°" class="border p-2 w-full mb-2"></textarea>
    <input id="imageUpload" type="file" accept="image/*" class="mb-4" />
    <button id="mintButton" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">é“¸é€  NFT</button>
    <p id="status" class="mt-4 text-sm text-gray-600 whitespace-pre-wrap"></p>
  </div>

  <script>
    const TOKEN_METADATA_PROGRAM_ID = new solanaWeb3.PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s");
    let provider = null;

    document.getElementById("connectWallet").onclick = async () => {
      if ("solana" in window) {
        provider = window.solana;
        await provider.connect();
        document.getElementById("connectWallet").innerText = "âœ… å·²è¿æ¥é’±åŒ…";
      } else {
        alert("è¯·å®‰è£… Phantom é’±åŒ…");
      }
    };

    async function uploadImageMock(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = btoa(reader.result);
          resolve("data:image;base64," + base64.slice(0, 100) + "..."); // æ¨¡æ‹Ÿæ•°æ® URI
        };
        reader.onerror = reject;
        reader.readAsBinaryString(file);
      });
    }

    document.getElementById("mintButton").onclick = async () => {
      const status = document.getElementById("status");
      const name = document.getElementById("nftName").value;
      const desc = document.getElementById("nftDesc").value;
      const file = document.getElementById("imageUpload").files[0];

      if (!provider || !provider.publicKey) {
        status.textContent = "âŒ è¯·å…ˆè¿æ¥é’±åŒ…";
        return;
      }
      if (!name || !file) {
        status.textContent = "âŒ è¯·å¡«å†™å®Œæ•´ä¿¡æ¯";
        return;
      }

      // ç­‰å¾… SPL Token åº“åŠ è½½
      if (!window.splToken) {
        status.textContent = "âŒ SPL Token åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•";
        return;
      }

      // æ£€æŸ¥åº“çš„æ–¹æ³•æ˜¯å¦å¯ç”¨
      if (!window.splToken.getMinimumBalanceForRentExemptMint) {
        status.textContent = "âŒ SPL Token åº“æ–¹æ³•ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•";
        return;
      }

      status.textContent = "ğŸ“¦ æ­£åœ¨æ¨¡æ‹Ÿä¸Šä¼ å›¾ç‰‡...";
      try {
        const imageUri = await uploadImageMock(file);

        const connection = new solanaWeb3.Connection(
          "https://small-holy-forest.solana-mainnet.quiknode.pro/b59315ea187b3de1b3542c5c25d7f2d5b5410ff4/",
          "confirmed"
        );

        const mint = solanaWeb3.Keypair.generate();
        const token = window.splToken;

        // æ£€æŸ¥ SPL Token åº“æ˜¯å¦æ­£ç¡®åŠ è½½
        if (!token || !token.getMinimumBalanceForRentExemptMint) {
          throw new Error("SPL Token åº“æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
        }

        const lamports = await token.getMinimumBalanceForRentExemptMint(connection);
        const associatedTokenAddress = await token.getAssociatedTokenAddress(
          mint.publicKey,
          provider.publicKey
        );

        const tx = new solanaWeb3.Transaction();

        // åˆ›å»º mint è´¦æˆ·
        tx.add(
          solanaWeb3.SystemProgram.createAccount({
            fromPubkey: provider.publicKey,
            newAccountPubkey: mint.publicKey,
            lamports,
            space: token.MINT_SIZE,
            programId: token.TOKEN_PROGRAM_ID,
          }),
          token.createInitializeMintInstruction(
            mint.publicKey,
            0,
            provider.publicKey,
            provider.publicKey
          ),
          token.createAssociatedTokenAccountInstruction(
            provider.publicKey,
            associatedTokenAddress,
            provider.publicKey,
            mint.publicKey
          ),
          token.createMintToInstruction(
            mint.publicKey,
            associatedTokenAddress,
            provider.publicKey,
            1
          )
        );

        tx.feePayer = provider.publicKey;
        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;

        tx.sign(mint);
        const signedTx = await provider.signTransaction(tx);
        const txid = await connection.sendRawTransaction(signedTx.serialize());
        await connection.confirmTransaction(txid);

        status.textContent = `âœ… NFT é“¸é€ æˆåŠŸï¼\näº¤æ˜“å“ˆå¸Œï¼š${txid}\næŸ¥çœ‹ï¼šhttps://explorer.solana.com/tx/${txid}`;
      } catch (err) {
        console.error(err);
        status.textContent = "âŒ å‡ºé”™äº†: " + err.message;
      }
    };
  </script>
</body>
</html>
