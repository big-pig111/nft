<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Solana NFT é“¸é€ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Buffer Polyfill for browser -->
  <script src="https://bundle.run/buffer@6.0.3"></script>
  <script>
    window.Buffer = buffer.Buffer;
  </script>
  
  <!-- Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
  
  <!-- Arweave -->
  <script src="https://unpkg.com/arweave@1.14.0/bundles/web.bundle.min.js"></script>
  
  <script>
    console.log("Solana Web3.js åŠ è½½æˆåŠŸ");
    console.log("Buffer å¯ç”¨:", typeof window.Buffer !== 'undefined');
    console.log("Arweave å¯ç”¨:", typeof window.Arweave !== 'undefined');
  </script>
</head>
<body class="bg-gray-100">
  <div class="max-w-xl mx-auto mt-10 p-6 bg-white shadow-lg rounded-xl">
    <h1 class="text-2xl font-bold mb-4">Solana + Arweave åŒé‡ä¸Šé“¾</h1>
    <p class="text-sm text-gray-600 mb-4">å°†æ‚¨çš„ç…§ç‰‡å’Œæ–‡å­—æ°¸ä¹…é“­åˆ»åœ¨ Solana åŒºå—é“¾å’Œ Arweave å»ä¸­å¿ƒåŒ–å­˜å‚¨ä¸Š</p>
    <button id="connectWallet" class="bg-blue-600 text-white px-4 py-2 rounded mb-4">è¿æ¥é’±åŒ…</button>
    <button id="checkLibraries" class="bg-green-600 text-white px-4 py-2 rounded mb-4 ml-2">æ£€æŸ¥åº“çŠ¶æ€</button>
    <button id="viewNFTs" class="bg-orange-600 text-white px-4 py-2 rounded mb-4 ml-2">æŸ¥çœ‹æˆ‘çš„ NFT</button>
    <button id="verifyOnChain" class="bg-red-600 text-white px-4 py-2 rounded mb-4 ml-2">é“¾ä¸ŠéªŒè¯</button>
    <input id="nftName" type="text" placeholder="è¾“å…¥åç§°" class="border p-2 w-full mb-2" />
    <textarea id="nftDesc" placeholder="è¾“å…¥æè¿°" class="border p-2 w-full mb-2"></textarea>
    <input id="imageUpload" type="file" accept="image/*" class="mb-4" />
    <button id="mintButton" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">åŒé‡ä¸Šé“¾</button>
    <p class="text-xs text-gray-500 mt-2">æ³¨æ„ï¼šåŒé‡ä¸Šé“¾éœ€è¦æ”¯ä»˜ Solana ç½‘ç»œè´¹ç”¨ï¼ˆçº¦ 0.00001 SOLï¼‰+ Arweave å­˜å‚¨è´¹ç”¨ï¼ˆå…è´¹ï¼‰</p>
    <p id="status" class="mt-4 text-sm text-gray-600 whitespace-pre-wrap"></p>
  </div>

  <script>
    const TOKEN_METADATA_PROGRAM_ID = new solanaWeb3.PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s");
    let provider = null;

    document.getElementById("connectWallet").onclick = async () => {
      if ("solana" in window) {
        provider = window.solana;
        await provider.connect();
        document.getElementById("connectWallet").innerText = "âœ… å·²è¿æ¥é’±åŒ…";
      } else {
        alert("è¯·å®‰è£… Phantom é’±åŒ…");
      }
    };

    document.getElementById("checkLibraries").onclick = () => {
      const status = document.getElementById("status");
      const libraries = {
        "Solana Web3.js": typeof solanaWeb3 !== 'undefined',
        "Buffer": typeof window.Buffer !== 'undefined',
        "Arweave": typeof window.Arweave !== 'undefined'
      };
      
      let statusText = "ğŸ“Š åº“çŠ¶æ€æ£€æŸ¥ï¼š\n\n";
      Object.entries(libraries).forEach(([name, loaded]) => {
        statusText += `${loaded ? 'âœ…' : 'âŒ'} ${name}: ${loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}\n`;
      });
      
      statusText += "\nğŸ’¡ ä½¿ç”¨ Arweave + Solana åŒé‡ä¸Šé“¾";
      
      status.textContent = statusText;
    };

    document.getElementById("viewNFTs").onclick = () => {
      const status = document.getElementById("status");
      
      // è·å–æ‰€æœ‰ä¿å­˜çš„ NFT
      const nfts = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('nft_')) {
          try {
            const nftData = JSON.parse(localStorage.getItem(key));
            nfts.push({ key, ...nftData });
          } catch (e) {
            console.error('è§£æ NFT æ•°æ®å¤±è´¥:', e);
          }
        }
      }
      
      if (nfts.length === 0) {
        status.textContent = "ğŸ“­ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½• NFT";
        return;
      }
      
      // æŒ‰åˆ›å»ºæ—¶é—´æ’åº
      nfts.sort((a, b) => new Date(b.created) - new Date(a.created));
      
      let statusText = `ğŸ“š æ‰¾åˆ° ${nfts.length} ä¸ª NFTï¼š\n\n`;
      
      nfts.forEach((nft, index) => {
        statusText += `ğŸ¨ NFT ${index + 1}ï¼š\n`;
        statusText += `ğŸ“ åç§°ï¼š${nft.name}\n`;
        statusText += `ğŸ“„ æè¿°ï¼š${nft.description}\n`;
        statusText += `ğŸ‘› é’±åŒ…ï¼š${nft.walletAddress}\n`;
        statusText += `ğŸ“Š äº¤æ˜“ï¼š${nft.transactionHash}\n`;
        statusText += `ğŸŒ æŸ¥çœ‹ï¼š${nft.solanaExplorer}\n`;
        statusText += `ğŸ“… åˆ›å»ºï¼š${new Date(nft.created).toLocaleString()}\n`;
        statusText += `ğŸ–¼ï¸ å›¾ç‰‡ï¼šå·²ä¿å­˜ï¼ˆBase64æ ¼å¼ï¼‰\n\n`;
        
        // åˆ›å»ºæŸ¥çœ‹å›¾ç‰‡çš„é“¾æ¥
        const imageKey = `image_${nft.key}`;
        if (!localStorage.getItem(imageKey)) {
          localStorage.setItem(imageKey, nft.image);
        }
      });
      
      statusText += `ğŸ’¡ æç¤ºï¼š\n`;
      statusText += `â€¢ å›¾ç‰‡æ•°æ®å·²ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­\n`;
      statusText += `â€¢ å¯ä»¥åœ¨å¼€å‘è€…å·¥å…·ä¸­æŸ¥çœ‹å®Œæ•´æ•°æ®\n`;
      statusText += `â€¢ äº¤æ˜“å“ˆå¸Œå¯ä»¥æ°¸ä¹…éªŒè¯æ•°æ®å­˜åœ¨\n\n`;
      statusText += `ğŸ–¼ï¸ æŸ¥çœ‹å›¾ç‰‡ï¼š\n`;
      
      nfts.forEach((nft, index) => {
        const imageKey = `image_${nft.key}`;
        const imageData = localStorage.getItem(imageKey) || nft.image;
        if (imageData) {
          statusText += `â€¢ NFT ${index + 1} å›¾ç‰‡ï¼š`;
          statusText += `<a href="${imageData}" target="_blank" style="color: blue; text-decoration: underline;">ç‚¹å‡»æŸ¥çœ‹</a>\n`;
        }
      });
      
      status.textContent = statusText;
    };

    // è¾…åŠ©å‡½æ•°ï¼šæ–‡ä»¶è½¬ Base64
    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }
    
    document.getElementById("mintButton").onclick = async () => {
      const status = document.getElementById("status");
      const name = document.getElementById("nftName").value;
      const desc = document.getElementById("nftDesc").value;
      const file = document.getElementById("imageUpload").files[0];

      if (!provider || !provider.publicKey) {
        status.textContent = "âŒ è¯·å…ˆè¿æ¥é’±åŒ…";
        return;
      }
      if (!name || !desc || !file) {
        status.textContent = "âŒ è¯·å¡«å†™å®Œæ•´çš„ NFT ä¿¡æ¯ï¼ˆåç§°ã€æè¿°ã€å›¾ç‰‡ï¼‰";
        return;
      }

      // æ£€æŸ¥ Buffer æ˜¯å¦å¯ç”¨
      if (typeof window.Buffer === 'undefined') {
        status.textContent = "âŒ Buffer æœªå®šä¹‰ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•";
        return;
      }

      status.textContent = "ğŸ“¦ æ­£åœ¨åˆ›å»º NFT...";
      try {
        const connection = new solanaWeb3.Connection(
          "https://small-holy-forest.solana-mainnet.quiknode.pro/b59315ea187b3de1b3542c5c25d7f2d5b5410ff4/",
          "confirmed"
        );

        // ä½¿ç”¨æœ€ç®€å•çš„æ–¹æ³•åˆ›å»º NFT
        await createSimpleNFT(connection, provider, name, desc, file, status);
      } catch (err) {
        console.error(err);
        status.textContent = "âŒ å‡ºé”™äº†: " + err.message;
      }
    };
    
    // æœ€ç®€å•çš„ NFT åˆ›å»ºæ–¹æ³•
    async function createSimpleNFT(connection, provider, name, desc, file, status) {
      try {
        status.textContent = "ğŸ”„ æ­£åœ¨å¤„ç†å›¾ç‰‡å’Œæ–‡å­—...";
        
        // æ£€æŸ¥ Arweave æ˜¯å¦å¯ç”¨
        if (typeof window.Arweave === 'undefined') {
          throw new Error("Arweave åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
        }
        
        // åˆå§‹åŒ– Arweave
        const arweave = window.Arweave.init({
          host: 'arweave.net',
          port: 443,
          protocol: 'https'
        });
        
        // å°†å›¾ç‰‡è½¬æ¢ä¸º ArrayBuffer
        const imageBuffer = await file.arrayBuffer();
        
        // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡åˆ° Arweave
        status.textContent = "ğŸ“¤ æ­¥éª¤ 1/3: æ­£åœ¨ä¸Šä¼ å›¾ç‰‡åˆ° Arweave...";
        
        const imageTransaction = await arweave.createTransaction({
          data: new Uint8Array(imageBuffer)
        });
        
        imageTransaction.addTag('Content-Type', file.type);
        imageTransaction.addTag('Title', `${name} - Image`);
        imageTransaction.addTag('Description', desc);
        imageTransaction.addTag('Creator', provider.publicKey.toString());
        imageTransaction.addTag('Type', 'NFT-Image');
        
        await arweave.transactions.sign(imageTransaction);
        const imageUploadResponse = await arweave.transactions.post(imageTransaction);
        
        if (imageUploadResponse.status !== 200 && imageUploadResponse.status !== 202) {
          throw new Error("å›¾ç‰‡ä¸Šä¼ åˆ° Arweave å¤±è´¥");
        }
        
        const imageArweaveId = imageTransaction.id;
        console.log("å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼ŒArweave ID:", imageArweaveId);
        
        // ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå¹¶ä¸Šä¼ å…ƒæ•°æ®åˆ° Arweave
        status.textContent = "ğŸ“ æ­¥éª¤ 2/3: æ­£åœ¨ä¸Šä¼ å…ƒæ•°æ®åˆ° Arweave...";
        
        const metadata = {
          name: name,
          description: desc,
          image: `https://arweave.net/${imageArweaveId}`,
          creator: provider.publicKey.toString(),
          created: new Date().toISOString(),
          type: "NFT",
          blockchain: "Solana",
          arweaveImageId: imageArweaveId
        };
        
        const metadataTransaction = await arweave.createTransaction({
          data: JSON.stringify(metadata, null, 2)
        });
        
        metadataTransaction.addTag('Content-Type', 'application/json');
        metadataTransaction.addTag('Title', `${name} - Metadata`);
        metadataTransaction.addTag('Description', desc);
        metadataTransaction.addTag('Creator', provider.publicKey.toString());
        metadataTransaction.addTag('Type', 'NFT-Metadata');
        metadataTransaction.addTag('Image-Id', imageArweaveId);
        
        await arweave.transactions.sign(metadataTransaction);
        const metadataUploadResponse = await arweave.transactions.post(metadataTransaction);
        
        if (metadataUploadResponse.status !== 200 && metadataUploadResponse.status !== 202) {
          throw new Error("å…ƒæ•°æ®ä¸Šä¼ åˆ° Arweave å¤±è´¥");
        }
        
        const metadataArweaveId = metadataTransaction.id;
        console.log("å…ƒæ•°æ®ä¸Šä¼ æˆåŠŸï¼ŒArweave ID:", metadataArweaveId);
        
        // ç¬¬ä¸‰æ­¥ï¼šåœ¨ Solana ä¸Šåˆ›å»ºåŒ…å« Arweave é“¾æ¥çš„äº¤æ˜“
        status.textContent = "ğŸ”— æ­¥éª¤ 3/3: æ­£åœ¨å°†é“¾æ¥é“­åˆ»åˆ° Solana åŒºå—é“¾...";
        
        const transaction = new solanaWeb3.Transaction();
        
        // æ·»åŠ åŒ…å« Arweave é“¾æ¥çš„å¤‡å¿˜å½•æŒ‡ä»¤
        const memoData = Buffer.from(`NFT: ${name} - ${desc} | Image: https://arweave.net/${imageArweaveId} | Metadata: https://arweave.net/${metadataArweaveId}`, 'utf8');
        const memoInstruction = new solanaWeb3.TransactionInstruction({
          keys: [
            { pubkey: provider.publicKey, isSigner: true, isWritable: false }
          ],
          programId: new solanaWeb3.PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),
          data: memoData
        });
        
        transaction.add(memoInstruction);
        
        // æ·»åŠ è½¬è´¦æŒ‡ä»¤
        const transferInstruction = solanaWeb3.SystemProgram.transfer({
          fromPubkey: provider.publicKey,
          toPubkey: provider.publicKey,
          lamports: 1000,
        });
        
        transaction.add(transferInstruction);
        
        // è®¾ç½®äº¤æ˜“å‚æ•°
        transaction.feePayer = provider.publicKey;
        const { blockhash } = await connection.getLatestBlockhash();
        transaction.recentBlockhash = blockhash;
        
        // ç­¾åå¹¶å‘é€äº¤æ˜“
        const signedTx = await provider.signTransaction(transaction);
        const txid = await connection.sendRawTransaction(signedTx.serialize());
        await connection.confirmTransaction(txid);
        
        // åˆ›å»ºå®Œæ•´çš„ NFT ä¿¡æ¯
        const nftInfo = {
          ...metadata,
          transactionHash: txid,
          solanaExplorer: `https://explorer.solana.com/tx/${txid}`,
          walletAddress: provider.publicKey.toString(),
          arweaveImageUrl: `https://arweave.net/${imageArweaveId}`,
          arweaveMetadataUrl: `https://arweave.net/${metadataArweaveId}`
        };
        
        // å°†å®Œæ•´çš„ NFT ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        const nftKey = `nft_${Date.now()}`;
        localStorage.setItem(nftKey, JSON.stringify(nftInfo));
        
        status.textContent = `âœ… NFT åŒé‡ä¸Šé“¾æˆåŠŸï¼\n\nğŸ¨ NFT åç§°ï¼š${name}\nğŸ“ æè¿°ï¼š${desc}\nğŸ‘› é’±åŒ…åœ°å€ï¼š${provider.publicKey.toString()}\nğŸ“Š Solana äº¤æ˜“ï¼š${txid}\n\nğŸ–¼ï¸ å›¾ç‰‡é“¾æ¥ï¼šhttps://arweave.net/${imageArweaveId}\nğŸ“„ å…ƒæ•°æ®é“¾æ¥ï¼šhttps://arweave.net/${metadataArweaveId}\n\nğŸŒ æŸ¥çœ‹ Solana äº¤æ˜“ï¼šhttps://explorer.solana.com/tx/${txid}\nğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨\n\næ‚¨çš„å›¾ç‰‡å’Œæ–‡å­—å·²å®Œå…¨ä¸Šé“¾ï¼`;
        
        console.log("NFT åŒé‡ä¸Šé“¾æˆåŠŸ:", nftInfo);
        
      } catch (err) {
        console.error(err);
        status.textContent = "âŒ å‡ºé”™äº†: " + err.message;
      }
    }

    document.getElementById("verifyOnChain").onclick = async () => {
      const status = document.getElementById("status");
      
      if (!provider || !provider.publicKey) {
        status.textContent = "âŒ è¯·å…ˆè¿æ¥é’±åŒ…";
        return;
      }
      
      status.textContent = "ğŸ” æ­£åœ¨éªŒè¯é“¾ä¸Šæ•°æ®...";
      
      try {
        const connection = new solanaWeb3.Connection(
          "https://small-holy-forest.solana-mainnet.quiknode.pro/b59315ea187b3de1b3542c5c25d7f2d5b5410ff4/",
          "confirmed"
        );
        
        // è·å–é’±åŒ…çš„æ‰€æœ‰äº¤æ˜“
        const signatures = await connection.getSignaturesForAddress(
          provider.publicKey,
          { limit: 20 }
        );
        
        let verifiedNFTs = [];
        
        for (const sig of signatures) {
          try {
            const transaction = await connection.getTransaction(sig.signature, {
              maxSupportedTransactionVersion: 0
            });
            
            if (transaction && transaction.meta) {
              // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤‡å¿˜å½•æŒ‡ä»¤
              const memoInstructions = transaction.transaction.message.instructions.filter(
                inst => inst.programId.toString() === "MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"
              );
              
              if (memoInstructions.length > 0) {
                // è§£ç å¤‡å¿˜å½•æ•°æ®
                const memoData = transaction.transaction.message.instructions.find(
                  inst => inst.programId.toString() === "MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"
                );
                
                if (memoData && memoData.data) {
                  const memoText = Buffer.from(memoData.data, 'base64').toString('utf8');
                  if (memoText.startsWith('NFT:')) {
                    verifiedNFTs.push({
                      signature: sig.signature,
                      memo: memoText,
                      blockTime: sig.blockTime,
                      slot: sig.slot
                    });
                  }
                }
              }
            }
          } catch (err) {
            console.log("è·³è¿‡äº¤æ˜“:", sig.signature, err.message);
          }
        }
        
        if (verifiedNFTs.length === 0) {
          status.textContent = "ğŸ“­ åœ¨é“¾ä¸Šæœªæ‰¾åˆ° NFT æ•°æ®\n\nè¯·ç¡®ä¿ï¼š\nâ€¢ å·²ç»æˆåŠŸåˆ›å»ºäº† NFT\nâ€¢ ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªé’±åŒ…åœ°å€";
          return;
        }
        
        let statusText = `âœ… åœ¨é“¾ä¸Šæ‰¾åˆ° ${verifiedNFTs.length} ä¸ª NFTï¼š\n\n`;
        
        verifiedNFTs.forEach((nft, index) => {
          const date = new Date(nft.blockTime * 1000).toLocaleString();
          statusText += `ğŸ¨ NFT ${index + 1}ï¼š\n`;
          statusText += `ğŸ“ æ•°æ®ï¼š${nft.memo}\n`;
          statusText += `ğŸ“Š äº¤æ˜“ï¼š${nft.signature}\n`;
          statusText += `ğŸŒ æŸ¥çœ‹ï¼šhttps://explorer.solana.com/tx/${nft.signature}\n`;
          statusText += `ğŸ“… æ—¶é—´ï¼š${date}\n`;
          statusText += `ğŸ”¢ åŒºå—ï¼š${nft.slot}\n\n`;
        });
        
        statusText += `ğŸ’¡ éªŒè¯ç»“æœï¼š\n`;
        statusText += `â€¢ âœ… æ‰€æœ‰ NFT æ•°æ®éƒ½æ°¸ä¹…ä¿å­˜åœ¨ Solana åŒºå—é“¾ä¸Š\n`;
        statusText += `â€¢ âœ… ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡äº¤æ˜“å“ˆå¸ŒéªŒè¯æ•°æ®å­˜åœ¨\n`;
        statusText += `â€¢ âœ… æ•°æ®ä¸å¯ç¯¡æ”¹ï¼Œæ°¸ä¹…æœ‰æ•ˆ\n`;
        statusText += `â€¢ ğŸ”— ç‚¹å‡»ä¸Šé¢çš„é“¾æ¥å¯ä»¥åœ¨ Solana æµè§ˆå™¨ä¸­æŸ¥çœ‹`;
        
        status.textContent = statusText;
        
      } catch (err) {
        console.error(err);
        status.textContent = "âŒ éªŒè¯å¤±è´¥: " + err.message;
      }
    };
  </script>
</body>
</html>
