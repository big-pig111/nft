<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Solana NFT é“¸é€ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Buffer Polyfill for browser -->
  <script src="https://bundle.run/buffer@6.0.3"></script>
  <script>
    window.Buffer = buffer.Buffer;
  </script>
  
  <!-- Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
  
  <!-- Metaplex - ä¸»è¦ CDN -->
  <script src="https://unpkg.com/@metaplex-foundation/js@4.12.0/lib/index.iife.min.js"></script>
  
  <script>
    console.log("Solana Web3.js åŠ è½½æˆåŠŸ");
    console.log("Buffer å¯ç”¨:", typeof window.Buffer !== 'undefined');
    
    // ç«‹å³æ£€æŸ¥ Metaplex
    function checkMetaplex() {
      if (window.mpl) {
        console.log("Metaplex åº“åŠ è½½æˆåŠŸ (mpl)");
        window.metaplex = window.mpl;
        return true;
      } else if (window.Metaplex) {
        console.log("Metaplex åº“åŠ è½½æˆåŠŸ (Metaplex)");
        window.metaplex = window.Metaplex;
        return true;
      } else if (window["@metaplex-foundation/js"]) {
        console.log("Metaplex åº“åŠ è½½æˆåŠŸ (@metaplex-foundation/js)");
        window.metaplex = window["@metaplex-foundation/js"];
        return true;
      }
      return false;
    }
    
    // ç«‹å³å°è¯•
    if (!checkMetaplex()) {
      console.log("Metaplex åº“æœªç«‹å³åŠ è½½ï¼Œç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ...");
      
      // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåå†æ¬¡å°è¯•
      window.addEventListener('load', function() {
        if (!checkMetaplex()) {
          console.error("Metaplex åº“åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ CDN");
          
          // å°è¯•å¤‡ç”¨ CDN
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@metaplex-foundation/js@4.12.0/lib/index.iife.min.js';
          script.onload = function() {
            if (checkMetaplex()) {
              console.log("Metaplex åº“å¤‡ç”¨ CDN åŠ è½½æˆåŠŸ");
            } else {
              console.error("æ‰€æœ‰ Metaplex åº“åŠ è½½å°è¯•éƒ½å¤±è´¥");
            }
          };
          script.onerror = function() {
            console.error("å¤‡ç”¨ CDN ä¹ŸåŠ è½½å¤±è´¥");
          };
          document.head.appendChild(script);
        }
      });
    }
  </script>
</head>
<body class="bg-gray-100">
  <div class="max-w-xl mx-auto mt-10 p-6 bg-white shadow-lg rounded-xl">
    <h1 class="text-2xl font-bold mb-4">Solana NFT é“¸é€ </h1>
    <p class="text-sm text-gray-600 mb-4">å°†æ‚¨çš„ç…§ç‰‡å’Œæ–‡å­—é“­åˆ»åœ¨ Solana ä¸»ç½‘ä¸Šï¼Œåˆ›å»ºçœŸæ­£çš„ NFT</p>
    <button id="connectWallet" class="bg-blue-600 text-white px-4 py-2 rounded mb-4">è¿æ¥é’±åŒ…</button>
    <button id="checkLibraries" class="bg-green-600 text-white px-4 py-2 rounded mb-4 ml-2">æ£€æŸ¥åº“çŠ¶æ€</button>
    <input id="nftName" type="text" placeholder="è¾“å…¥ NFT åç§°" class="border p-2 w-full mb-2" />
    <textarea id="nftDesc" placeholder="è¾“å…¥ NFT æè¿°" class="border p-2 w-full mb-2"></textarea>
    <input id="imageUpload" type="file" accept="image/*" class="mb-4" />
    <button id="mintButton" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">é“¸é€  NFT</button>
    <p class="text-xs text-gray-500 mt-2">æ³¨æ„ï¼šé“¸é€  NFT éœ€è¦æ”¯ä»˜ Solana ç½‘ç»œè´¹ç”¨ï¼ˆçº¦ 0.01-0.05 SOLï¼‰</p>
    <p id="status" class="mt-4 text-sm text-gray-600 whitespace-pre-wrap"></p>
  </div>

  <script>
    const TOKEN_METADATA_PROGRAM_ID = new solanaWeb3.PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s");
    let provider = null;

    document.getElementById("connectWallet").onclick = async () => {
      if ("solana" in window) {
        provider = window.solana;
        await provider.connect();
        document.getElementById("connectWallet").innerText = "âœ… å·²è¿æ¥é’±åŒ…";
      } else {
        alert("è¯·å®‰è£… Phantom é’±åŒ…");
      }
    };

    document.getElementById("checkLibraries").onclick = () => {
      const status = document.getElementById("status");
      const libraries = {
        "Solana Web3.js": typeof solanaWeb3 !== 'undefined',
        "Buffer": typeof window.Buffer !== 'undefined',
        "Metaplex": typeof window.metaplex !== 'undefined'
      };
      
      let statusText = "ğŸ“Š åº“çŠ¶æ€æ£€æŸ¥ï¼š\n\n";
      Object.entries(libraries).forEach(([name, loaded]) => {
        statusText += `${loaded ? 'âœ…' : 'âŒ'} ${name}: ${loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}\n`;
      });
      
      if (!libraries["Metaplex"]) {
        statusText += "\nğŸ’¡ å¦‚æœ Metaplex æœªåŠ è½½ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ³•";
      }
      
      status.textContent = statusText;
    };

    // å¤‡ç”¨çš„ç®€å• NFT é“¸é€ æ–¹æ³•
    async function createSimpleNFT(connection, provider, name, desc, file, status) {
      status.textContent = "ğŸ”„ ä½¿ç”¨å¤‡ç”¨æ–¹æ³•åˆ›å»º NFT...";
      
      // åˆ›å»ºä¸€ä¸ªç®€å•çš„ä»£å¸è´¦æˆ·ä½œä¸º NFT
      const mint = solanaWeb3.Keypair.generate();
      const tokenAccount = solanaWeb3.Keypair.generate();
      
      // åˆ›å»ºäº¤æ˜“
      const transaction = new solanaWeb3.Transaction();
      
      // åˆ›å»º mint è´¦æˆ·
      const lamports = await connection.getMinimumBalanceForRentExemption(82);
      transaction.add(
        solanaWeb3.SystemProgram.createAccount({
          fromPubkey: provider.publicKey,
          newAccountPubkey: mint.publicKey,
          lamports: lamports,
          space: 82,
          programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"),
        })
      );
      
      // åˆå§‹åŒ– mint
      transaction.add(
        new solanaWeb3.TransactionInstruction({
          keys: [
            { pubkey: mint.publicKey, isSigner: false, isWritable: true },
            { pubkey: new solanaWeb3.PublicKey("11111111111111111111111111111111"), isSigner: false, isWritable: false },
          ],
          programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"),
          data: Buffer.from([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
        })
      );
      
      transaction.feePayer = provider.publicKey;
      const { blockhash } = await connection.getLatestBlockhash();
      transaction.recentBlockhash = blockhash;
      
      // ç­¾åå¹¶å‘é€äº¤æ˜“
      transaction.sign(mint);
      const signedTx = await provider.signTransaction(transaction);
      const txid = await connection.sendRawTransaction(signedTx.serialize());
      await connection.confirmTransaction(txid);
      
      status.textContent = `âœ… å¤‡ç”¨ NFT åˆ›å»ºæˆåŠŸï¼\n\nMint åœ°å€ï¼š${mint.publicKey.toString()}\näº¤æ˜“å“ˆå¸Œï¼š${txid}\n\næŸ¥çœ‹ï¼šhttps://explorer.solana.com/address/${mint.publicKey.toString()}\n\næ³¨æ„ï¼šè¿™æ˜¯åŸºç¡€ä»£å¸ï¼Œä¸æ˜¯æ ‡å‡† NFT å…ƒæ•°æ®æ ¼å¼`;
    }

    document.getElementById("mintButton").onclick = async () => {
      const status = document.getElementById("status");
      const name = document.getElementById("nftName").value;
      const desc = document.getElementById("nftDesc").value;
      const file = document.getElementById("imageUpload").files[0];

      if (!provider || !provider.publicKey) {
        status.textContent = "âŒ è¯·å…ˆè¿æ¥é’±åŒ…";
        return;
      }
      if (!name || !desc || !file) {
        status.textContent = "âŒ è¯·å¡«å†™å®Œæ•´çš„ NFT ä¿¡æ¯ï¼ˆåç§°ã€æè¿°ã€å›¾ç‰‡ï¼‰";
        return;
      }

      // æ£€æŸ¥ Buffer æ˜¯å¦å¯ç”¨
      if (typeof window.Buffer === 'undefined') {
        status.textContent = "âŒ Buffer æœªå®šä¹‰ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•";
        return;
      }

      status.textContent = "ğŸ“¦ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡åˆ° Arweave...";
      try {
        // æ£€æŸ¥ Metaplex æ˜¯å¦å¯ç”¨
        if (typeof window.metaplex === 'undefined') {
          status.textContent = "âŒ Metaplex åº“æœªåŠ è½½\n\næ­£åœ¨å°è¯•å¤‡ç”¨æ–¹æ³•...";
          
          // ä½¿ç”¨å¤‡ç”¨çš„ç®€å• NFT é“¸é€ æ–¹æ³•
          try {
            await createSimpleNFT(connection, provider, name, desc, file, status);
            return;
          } catch (err) {
            status.textContent = "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥\n\nè¯·å°è¯•ï¼š\n1. åˆ·æ–°é¡µé¢\n2. æ£€æŸ¥ç½‘ç»œè¿æ¥\n3. ç­‰å¾…å‡ ç§’åé‡è¯•\n\né”™è¯¯ï¼š" + err.message;
            return;
          }
        }

        const connection = new solanaWeb3.Connection(
          "https://small-holy-forest.solana-mainnet.quiknode.pro/b59315ea187b3de1b3542c5c25d7f2d5b5410ff4/",
          "confirmed"
        );

        // åˆ›å»º Metaplex å®ä¾‹
        const metaplex = new window.metaplex.Metaplex(connection);
        metaplex.use(window.metaplex.keypairIdentity(solanaWeb3.Keypair.generate()));

        // ä¸Šä¼ å›¾ç‰‡åˆ° Arweave
        status.textContent = "ğŸ“¤ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...";
        const imageBuffer = await file.arrayBuffer();
        const imageUri = await metaplex.storage().upload(new Uint8Array(imageBuffer));

        // åˆ›å»º NFT å…ƒæ•°æ®
        status.textContent = "ğŸ“ æ­£åœ¨åˆ›å»º NFT å…ƒæ•°æ®...";
        const { uri: metadataUri } = await metaplex.nfts().uploadMetadata({
          name: name,
          description: desc,
          image: imageUri,
          attributes: [
            { trait_type: "Creator", value: "Solana NFT Minting Tool" },
            { trait_type: "Created", value: new Date().toISOString() }
          ]
        });

        // é“¸é€  NFT
        status.textContent = "ğŸª™ æ­£åœ¨é“¸é€  NFT...";
        const { nft } = await metaplex.nfts().create({
          uri: metadataUri,
          name: name,
          sellerFeeBasisPoints: 500, // 5% ç‰ˆç¨
          maxSupply: 1,
          isMutable: true,
          mintAddress: solanaWeb3.Keypair.generate(),
          tokenOwner: provider.publicKey,
        });

        status.textContent = `âœ… NFT é“¸é€ æˆåŠŸï¼\n\nNFT åœ°å€ï¼š${nft.address.toString()}\nå…ƒæ•°æ®ï¼š${metadataUri}\nå›¾ç‰‡ï¼š${imageUri}\n\næŸ¥çœ‹ NFTï¼šhttps://explorer.solana.com/address/${nft.address.toString()}`;
      } catch (err) {
        console.error(err);
        status.textContent = "âŒ å‡ºé”™äº†: " + err.message;
      }
    };
  </script>
</body>
</html>
