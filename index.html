<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solana Token Transactions Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { margin: 10px 0; padding: 8px; width: 100%; }
    #result { margin-top: 20px; white-space: pre-wrap; background: #f5f5f5; padding: 10px; border-radius: 8px; }
    .test-btn { background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .test-btn:hover { background: #45a049; }
  </style>
</head>
<body>
  <h2>ğŸ” æŸ¥è¯¢ Solana ä¸ŠæŒ‡å®šä»£å¸çš„äº¤æ˜“è®°å½•</h2>

  <button onclick="testAPI()" class="test-btn">ğŸ§ª æµ‹è¯• API è¿æ¥</button>

  <label for="tokenAddress">è¾“å…¥ä»£å¸ Mint åœ°å€ï¼š</label>
  <input type="text" id="tokenAddress" placeholder="å¦‚ï¼šSo11111111111111111111111111111111111111112" />

  <button onclick="queryTransactions()">æŸ¥è¯¢æœ€è¿‘ 20 æ¡äº¤æ˜“è®°å½•</button>

  <div id="result">ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>

  <script>
    async function testAPI() {
      const resultDiv = document.getElementById("result");
      resultDiv.textContent = "æ­£åœ¨æµ‹è¯• API è¿æ¥...";
      
      try {
        const res = await fetch("/api/test-proxy", {
          method: "GET",
          headers: { "Content-Type": "application/json" }
        });

        if (!res.ok) {
          throw new Error(`æµ‹è¯•å¤±è´¥: ${res.status} - ${res.statusText}`);
        }

        const data = await res.json();
        resultDiv.textContent = `âœ… API æµ‹è¯•æˆåŠŸï¼\n\n${JSON.stringify(data, null, 2)}`;
      } catch (err) {
        resultDiv.textContent = `âŒ API æµ‹è¯•å¤±è´¥: ${err.message}`;
        console.error(err);
      }
    }

    async function queryTransactions() {
      const tokenAddress = document.getElementById("tokenAddress").value.trim();
      const resultDiv = document.getElementById("result");

      if (!tokenAddress) {
        resultDiv.textContent = "è¯·è¾“å…¥ä¸€ä¸ªä»£å¸ mint åœ°å€ã€‚";
        return;
      }

      try {
        resultDiv.textContent = "æ­£åœ¨æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨å€™...";
        
        // å°è¯•ä½¿ç”¨æœåŠ¡å™¨ç«¯å‡½æ•°ï¼ˆå¦‚æœå·²éƒ¨ç½²ï¼‰
        let apiUrl = "/api/helius-proxy";
        let useProxy = false;
        
        try {
          const res = await fetch(apiUrl, {
            method: "POST",
            headers: { 
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ tokenAddress })
          });

          if (res.ok) {
            const data = await res.json();
            
            if (data.error) {
              throw new Error(data.error);
            }

            if (!data.result || data.result.length === 0) {
              resultDiv.textContent = "æ²¡æœ‰æ‰¾åˆ°ç›¸å…³äº¤æ˜“è®°å½•ã€‚";
              return;
            }

            let output = "";
            data.result.forEach((tx, index) => {
              const time = new Date(tx.timestamp * 1000).toLocaleString();
              const sig = tx.signature;
              const amount = tx.rawTokenTransfers?.[0]?.tokenAmount || "æœªçŸ¥";
              const from = tx.rawTokenTransfers?.[0]?.fromUserAccount || "æœªçŸ¥";
              const to = tx.rawTokenTransfers?.[0]?.toUserAccount || "æœªçŸ¥";

              output += `ğŸŸ¢ ç¬¬ ${index + 1} æ¡äº¤æ˜“\næ—¶é—´: ${time}\nç­¾å: ${sig}\næ•°é‡: ${amount}\nFrom: ${from}\nTo: ${to}\n\n`;
            });

            resultDiv.textContent = output;
            return;
          } else {
            // å¦‚æœæœåŠ¡å™¨ç«¯å‡½æ•°è¿”å›é”™è¯¯ï¼Œè·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
            const errorData = await res.json().catch(() => ({}));
            throw new Error(`æœåŠ¡å™¨ç«¯å‡½æ•°é”™è¯¯: ${res.status} - ${errorData.error || res.statusText}`);
          }
        } catch (serverError) {
          console.log("æœåŠ¡å™¨ç«¯å‡½æ•°ä¸å¯ç”¨ï¼Œä½¿ç”¨ CORS ä»£ç†...", serverError);
          useProxy = true;
        }

        // å¦‚æœæœåŠ¡å™¨ç«¯å‡½æ•°ä¸å¯ç”¨ï¼Œä½¿ç”¨ CORS ä»£ç†
        if (useProxy) {
          const corsProxy = "https://api.allorigins.win/raw?url=";
          const heliusUrl = "https://api.helius.xyz/v0/transactions/search?api-key=17d82c3f-fbe0-451c-a882-70de20ad4162";

          const body = {
            jsonrpc: "2.0",
            id: "getTokenTransactions",
            method: "searchTransactions",
            params: {
              "query": {
                "rawTokenTransfers": {
                  "mint": tokenAddress
                }
              },
              "options": {
                "limit": 20,
                "sort": "desc"
              }
            }
          };

          const res = await fetch(corsProxy + encodeURIComponent(heliusUrl), {
            method: "POST",
            headers: { 
              "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
          });

          if (!res.ok) {
            throw new Error(`è¯·æ±‚å¤±è´¥: ${res.status} - ${res.statusText}`);
          }

          const data = await res.json();

          if (!data.result || data.result.length === 0) {
            resultDiv.textContent = "æ²¡æœ‰æ‰¾åˆ°ç›¸å…³äº¤æ˜“è®°å½•ã€‚";
            return;
          }

          let output = "";
          data.result.forEach((tx, index) => {
            const time = new Date(tx.timestamp * 1000).toLocaleString();
            const sig = tx.signature;
            const amount = tx.rawTokenTransfers?.[0]?.tokenAmount || "æœªçŸ¥";
            const from = tx.rawTokenTransfers?.[0]?.fromUserAccount || "æœªçŸ¥";
            const to = tx.rawTokenTransfers?.[0]?.toUserAccount || "æœªçŸ¥";

            output += `ğŸŸ¢ ç¬¬ ${index + 1} æ¡äº¤æ˜“\næ—¶é—´: ${time}\nç­¾å: ${sig}\næ•°é‡: ${amount}\nFrom: ${from}\nTo: ${to}\n\n`;
          });

          resultDiv.textContent = output;
        }
      } catch (err) {
        resultDiv.textContent = `æŸ¥è¯¢å¤±è´¥: ${err.message}\n\nè¯·ç¡®ä¿ï¼š\n1. æœåŠ¡å™¨ç«¯å‡½æ•°å·²æ­£ç¡®éƒ¨ç½²åˆ° Vercel\n2. æˆ–è€…æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•\n3. ç‚¹å‡»"æµ‹è¯• API è¿æ¥"æŒ‰é’®æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€`;
        console.error(err);
      }
    }
  </script>
</body>
</html>
